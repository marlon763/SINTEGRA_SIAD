//     financeiro {
//     gerar boleto => primeira e segunda via
//     consultar status
//     debloqueio de confian√ßa
//     falar com atendente
//     voltar nas opt anteriores
//     }

//     comercial {
//     sistema gerencial => marque a demonstracao
//     sistema gerencial/fiscal => marque a demonstracao
//     plano fidelidade => planos padr√µes com fidelidade de tempo ganha desconto, e em caso de quebra de contrato paga uma multa 
//     {plano 6 meses ganha desconto na parcela com uma porcentagem menor,plano 1 ano desconto maior na parcela e um desconto na implanta√ß√£o mas em caso de evas√£o tem maior multa} => marque a demonstracao
//     falar com atendente
//     voltar nas opt anteriores
//     }
    
//     nossa empresa => {
//     site 
//     localiza√ß√£o
//     numero de cada empresa
    
//     falar com atendente
//     voltar nas opt anteriores
//     }
    
//     suporte ao cliente => [treinar uma ia para passar por ela antes] => redirecionar para um atendente

// colatina @-19.5268914,-40.6314104   X

// carangola @-20.7298932,-42.0217229    X

// aimores @-19.4916757,-41.0614875   X

// cp @-19.1734092,-41.4731886   X
 
const path = require('path');
const banco = require("../DATA/banco");
const {  v4 : uuidv4  } = require ( 'uuid' );
const { getIo } = require("../SERVICES/socketio");

const menus = {
    principal: {
      mensagem: "Seja bem-vindo ao canal de atendimento SIAD Sistemas. Escolha uma op√ß√£o:\n\n1Ô∏è‚É£ Financeiro\n2Ô∏è‚É£ Comercial\n3Ô∏è‚É£ Nossa empresa\n4Ô∏è‚É£ Suporte ao cliente",
    },
    "1" : {
      mensagem: "Voc√™ est√° no setor Financeiro. Escolha uma op√ß√£o:\n\n1Ô∏è‚É£ Gerar boleto\n2Ô∏è‚É£ Consultar status\n3Ô∏è‚É£ Desbloqueio de confian√ßa\n4Ô∏è‚É£ Falar com atendente\n0Ô∏è‚É£ Voltar ao menu principal",
    },
    "2" : {
      mensagem: "Voc√™ est√° no setor Comercial. Escolha uma op√ß√£o:\n\n1Ô∏è‚É£ Sistema gerencial\n2Ô∏è‚É£ Sistema gerencial/fiscal\n3Ô∏è‚É£ Plano fidelidade\n4Ô∏è‚É£ Falar com atendente\n0Ô∏è‚É£ Voltar ao menu principal",
    },
    "3" : {
      mensagem: "Informa√ß√µes sobre a empresa. Escolha uma op√ß√£o:\n\n1Ô∏è‚É£ Nosso site\n2Ô∏è‚É£ Redes sociais\n3Ô∏è‚É£ Localiza√ß√£o das nossas filiais\n0Ô∏è‚É£ Voltar ao menu principal",
    },
    "4" : {
      mensagem: "Voc√™ est√° no setor de Suporte ao cliente. Escolha uma op√ß√£o:\n\n1Ô∏è‚É£ D√∫vidas t√©cnicas\n2Ô∏è‚É£ Problemas de acesso\n3Ô∏è‚É£ Solicitar treinamento\n4Ô∏è‚É£ Falar com atendente\n0Ô∏è‚É£ Voltar ao menu principal",
    },
    // Submenus do Financeiro
    "1.1": {
      mensagem: "0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "1.2": {
      mensagem: "Para consultar o status de pagamento, por favor informe o c√≥digo do cliente ou CNPJ/CPF:\n\n0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "1.3": {
      mensagem: "Para solicitar desbloqueio de confian√ßa, por favor informe o c√≥digo do cliente ou CNPJ/CPF:\n\n0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "1.4": {
      mensagem: "Aguarde um momento, voc√™ ser√° transferido para um atendente do setor financeiro.",
    },
    // Submenus do Comercial
    "2.1": {
      mensagem: "Informa√ß√µes sobre Sistema gerencial:\n\nO Sistema Gerencial SIAD oferece controle de estoque, vendas, financeiro e muito mais.\n\nDeseja receber mais informa√ß√µes?\n\n1Ô∏è‚É£ Sim, quero receber a proposta\n0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "2.2": {
      mensagem: "Informa√ß√µes sobre Sistema gerencial/fiscal:\n\nO Sistema Gerencial/Fiscal SIAD completo oferece todos os recursos gerenciais mais emiss√£o de NF-e, NFC-e, MDF-e e CT-e.\n\nDeseja receber mais informa√ß√µes?\n\n1Ô∏è‚É£ Sim, quero receber a proposta\n0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "2.3": {
      mensagem: "Informa√ß√µes sobre Plano fidelidade:\n\nO Plano Fidelidade SIAD oferece descontos especiais e suporte priorit√°rio.\n\nDeseja receber mais informa√ß√µes?\n\n1Ô∏è‚É£ Sim, quero receber a proposta\n0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "2.4": {
      mensagem: "Aguarde um momento, voc√™ ser√° transferido para um atendente do setor comercial.",
    },
    // Submenus da Nossa empresa
    "3.1": {
      mensagem: "Visite nosso site: https://siadvendas.com.br/\n\n0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "3.2": {
      mensagem: "Visite nossas redes sociais: https://www.instagram.com/siadsistemasbr?igsh=aWkzMnF4dmxpMG5w \n\n0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "3.3": {
      mensagem: "Escolha qual filial vc deseja:\n\n1Ô∏è‚É£ Aimores\n2Ô∏è‚É£ Carangola\n3Ô∏è‚É£ Colatina\n4Ô∏è‚É£ Conselheiro pena\n5Ô∏è‚É£ Todas as filiais\n\n0Ô∏è‚É£ Voltar ao menu anterior",
    },
    "3.3.1": {
      mensagem: "Fa√ßa-nos uma visita e conhe√ßa nosso trabalho!\n\n0Ô∏è‚É£ Voltar ao menu anterior",
      localizacao: {
        latitude: -19.491675,
        longitude: -41.0614875,
        cidade : "Aimores"
      }
    },
    "3.3.2": {
      mensagem: "Fa√ßa-nos uma visita e conhe√ßa nosso trabalho!\n\n0Ô∏è‚É£ Voltar ao menu anterior",
      localizacao: {
        latitude: -20.7298932,
        longitude: -42.0217229,
        cidade : "Carangola"        
      }
    },
    "3.3.3": {
      mensagem: "Fa√ßa-nos uma visita e conhe√ßa nosso trabalho!\n\n0Ô∏è‚É£ Voltar ao menu anterior",
      localizacao: {
        latitude: -19.5268914,
        longitude: -40.6314104,
        cidade : "Colatina"
      }
    },
    "3.3.4": {
      mensagem: "Fa√ßa-nos uma visita e conhe√ßa nosso trabalho!\n\n0Ô∏è‚É£ Voltar ao menu anterior",
      localizacao: {
        latitude: -19.1734092,
        longitude: -41.4731886,
        cidade : "Conselheiro Pena"
      }
    },
    "3.3.5": {
      mensagem: "Fa√ßa-nos uma visita e conhe√ßa nosso trabalho!\n\n0Ô∏è‚É£ Voltar ao menu anterior",
      localizacoes: [
        { latitude: -19.1734092, longitude: -41.4731886 ,cidade : "Aimores"},
        { latitude: -20.7298932, longitude: -42.0217229 ,cidade : "Carangola"},
        { latitude: -19.5268914, longitude: -40.6314104 ,cidade : "Colatina"},
        { latitude: -19.1734092, longitude: -41.4731886 ,cidade : "Conselheiro Pena"}
      ]
    },
    // Submenus do Suporte
    // "4.1": {
    //   mensagem: "Para d√∫vidas t√©cnicas, por favor descreva brevemente seu problema:\n\n0Ô∏è‚É£ Voltar ao menu anterior",
    // },
    // "4.2": {
    //   mensagem: "Para problemas de acesso, por favor informe seu usu√°rio e detalhes do problema:\n\n0Ô∏è‚É£ Voltar ao menu anterior",
    // },
    // "4.3": {
    //   mensagem: "Para solicitar treinamento, por favor informe o m√≥dulo desejado e quantas pessoas participar√£o:\n\n0Ô∏è‚É£ Voltar ao menu anterior",
    // },
    // "4.4": {
    //   mensagem: "Aguarde um momento, voc√™ ser√° transferido para um atendente do suporte t√©cnico.\n\n0Ô∏è‚É£ Voltar ao menu anterior",
    // },
};

const processarMensagem = async (client, message) => {

    try {
        const from = message.from;
        const texto = message.body.trim();
        const cliente = banco.db.find((numero) => numero.num === from);

        const proximoMenu = cliente.menuAtual === 'principal' ? texto : `${cliente.menuAtual}.${texto}`;

        if (texto === "0") {
            // Divide o caminho do menu e remove o √∫ltimo n√≠vel
            const menuAnterior = cliente.menuAtual.split('.').slice(0, -1).join('.') || 'principal';
            cliente.menuAtual = menuAnterior;
            await client.sendText(from, menus[menuAnterior].mensagem);
            return
        };
    
        if ((!menus[proximoMenu] && cliente.menuAtual !== 'principal') || (!menus[proximoMenu] && !menus[cliente.menuAtual])) {
            // Op√ß√£o inv√°lida
            cliente.menuAtual = 'principal'
            await client.sendText(from, `Op√ß√£o inv√°lida. Por favor, escolha uma das op√ß√µes dispon√≠veis.`);
            await client.sendText(from, menus.principal.mensagem);
            return
        };

        if (menus[proximoMenu]) {

            cliente.menuAtual = proximoMenu

            switch(proximoMenu){
                case "1":
                    await client.sendText(from, menus['1'].mensagem);
                break
        
                case "2":
                    await client.sendText(from, menus['2'].mensagem);
                break
        
                case "3":
                    await client.sendText(from, menus['3'].mensagem);
                break
        
                case "4":
                    //await client.sendText(from, menus['4'].mensagem);
                    const ticket = uuidv4()
                    cliente.ticket.id = ticket
                    cliente.Atendimento = true
                    await client.sendText(from, `Aguarde um momento, voc√™ ser√° transferido para um atendente do suporte.\n\nTicket üéü : ${ticket}`);
                break
        
                case "1.1": 
                const filePath = path.resolve(__dirname, 'BOLETO/boleto_exemplo.pdf');
                await client.sendFile(
                    from, // N√∫mero de telefone com DDI e DDD + "@c.us"
                    filePath, // Caminho para o arquivo local
                    'BOLETO.pdf',      // Nome do arquivo no WhatsApp
                    'Segue o documento em PDF.' // Mensagem opcional junto ao arquivo
                );
                await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "1.2":
                  await client.sendText(from, "Op√ß√£o ainda em desenvolvimento ‚öô\n\n0Ô∏è‚É£ Voltar ao menu anterior");
                break

                case "1.3":
                  await client.sendText(from, "Op√ß√£o ainda em desenvolvimento ‚öô\n\n0Ô∏è‚É£ Voltar ao menu anterior");
                break

                case "1.4":
                  cliente.Atendimento = true
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "2.1":
                  await client.sendText(from, "Op√ß√£o ainda em desenvolvimento ‚öô\n\n0Ô∏è‚É£ Voltar ao menu anterior");
                break

                case "2.2":
                  await client.sendText(from, "Op√ß√£o ainda em desenvolvimento ‚öô\n\n0Ô∏è‚É£ Voltar ao menu anterior");
                break

                case "2.3":
                  await client.sendText(from, "Op√ß√£o ainda em desenvolvimento ‚öô\n\n0Ô∏è‚É£ Voltar ao menu anterior");
                break

                case "2.4":
                  cliente.Atendimento = true
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "3.1":
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "3.2":
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "3.3":
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "3.3.1":
                  await client.sendLocation(
                    from, 
                    menus[cliente.menuAtual].localizacao.latitude, 
                    menus[cliente.menuAtual].localizacao.longitude, 
                    menus[cliente.menuAtual].localizacao.cidade)
                  .then((result) => {
                    console.log('Result: ', result);
                  })
                  .catch((erro) => {
                    //console.error('Error when sending: ', erro);
                  });
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "3.3.2":
                  await client.sendLocation(
                    from, 
                    menus[cliente.menuAtual].localizacao.latitude, 
                    menus[cliente.menuAtual].localizacao.longitude, 
                    menus[cliente.menuAtual].localizacao.cidade)
                  .then((result) => {
                    console.log('Result: ', result);
                  })
                  .catch((erro) => {
                    //console.error('Error when sending: ', erro);
                  });
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "3.3.3":
                  await client.sendLocation(
                    from, 
                    menus[cliente.menuAtual].localizacao.latitude, 
                    menus[cliente.menuAtual].localizacao.longitude, 
                    menus[cliente.menuAtual].localizacao.cidade)
                  .then((result) => {
                    console.log('Result: ', result);
                  })
                  .catch((erro) => {
                    //console.error('Error when sending: ', erro);
                  });
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "3.3.4":
                  await client.sendLocation(
                    from, 
                    menus[cliente.menuAtual].localizacao.latitude, 
                    menus[cliente.menuAtual].localizacao.longitude, 
                    menus[cliente.menuAtual].localizacao.cidade)
                  .then((result) => {
                    console.log('Result: ', result);
                  })
                  .catch((erro) => {
                    //console.error('Error when sending: ', erro);
                  });
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

                case "3.3.5":

                //console.log(cliente.menuAtual)

                for (const loc of menus[cliente.menuAtual].localizacoes) {
                  await client.sendLocation(from, loc.latitude, loc.longitude, loc.cidade)
                    .then((result) => console.log('Result:', result))
                    .catch((erro) => {
                      //console.error('Error when sending: ', erro);, erro)
                    });
                }
                  await client.sendText(from, menus[cliente.menuAtual].mensagem);
                break

            }; 
            return
        };
    } catch (error) {
        console.error(error)
        //await client.sendText(from, `Erro ao processar mensagem, tente novamente`); 
    }
};


async function escutar(client, message) {
    const TEMPO_ESPERA = 15 * 60 * 1000;
    let cliente = banco.db.find((u) => u.num === message.from);
  
    if (!cliente) {
      // Envia mensagem de boas-vindas
      await client.sendText(message.from, menus.principal.mensagem);
  
      // Cria novo cliente com temporizador
      const temporiozador = setTimeout(() => {
        client.sendText(message.from, "Encerrando o atendimento por inatividade. Obrigado por conversar conosco!");
        // Remove o cliente do banco (opcional) ou apenas o temporizador
        const idx = banco.db.findIndex(u => u.num === message.from);
        if (idx !== -1) {
          banco.db[idx].temporiozador = null;
        }
      }, TEMPO_ESPERA);
  
      cliente = {
        ticket : {
          id : null,
          status : 'entrada',
        },
        dados : [],
        temporiozador,
        num : message.from,
        Atendimento : false,
        esperandoDados : false,
        menuAtual : 'principal',
        nome : message.sender.pushname,
        img : message.sender.profilePicThumbObj.eurl,
      };
  
      banco.db.push(cliente);
    }

    // Se j√° existe, cancela o temporizador antigo
    clearTimeout(cliente.temporiozador);
  
    // Define um novo temporizador
      cliente.temporiozador = setTimeout(() => {
        client.sendText(
          message.from,
          "Encerrando o atendimento por inatividade. Obrigado por conversar conosco!"
        );
        delete cliente.temporiozador;
    }, TEMPO_ESPERA);
    
    return;
}


function autoSendMessage(client, sessionName) {
    client.onMessage(async (message) => {

      //verifica se a mensagem √© de algum grupo, status ou se o cliente esta em um atendimento para ignorar a mensagem
      if (message.isGroupMsg || message.from === "status@broadcast") return;

      await escutar(client, message);

      const from = message.from;      
      const cliente = banco.db.find((numero) => numero.num === from);

      if (cliente.Atendimento === true) {

        const horario = (timestamp) => {
          const data = new Date(timestamp * 1000);
          return data.toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo' });
        };

        const texto = message.body.trim();
        // const nome = message.sender.pushname;
        // const img = message.sender.profilePicThumbObj.eurl;
        const horarioFormatado = horario(message.timestamp);

        cliente.dados.push({
          texto, 
          enviado: false, 
          horario: horarioFormatado
        })

        const obj = {
          img : cliente.img,
          from,
          nome : cliente.nome,
          id : cliente.ticket,
          ultimaMensagem : texto,
          mensagens : cliente.dados,
          horario : horarioFormatado,
          status : cliente.ticket.status,
        }

        //console.log(horarioFormatado)
        // console.log(cliente.ticket)
        // console.log(obj)

        const io = getIo();

        io.emit("mensagem-chat", obj);

        return
      }
      //
      await processarMensagem(client, message);
    });
}
module.exports = {
    autoSendMessage
};